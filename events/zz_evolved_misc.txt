# events\zz_evolved_misc.txt

namespace = tec_misc

planet_event = { # Ecoworld remove modifier
	id = tec_misc.1
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
		tec_is_ecoworld = yes
		OR = {
			tec_is_arcology = yes
			tec_invalidates_ecoworld_project_comp = yes
		}
	}

	immediate = {
		remove_modifier = pm_tec_ecoworld_planet
	}
	
}

country_event = {
	id = tec_misc.2
	hide_window = yes
	is_triggered_only = yes
	
	trigger = {
	}

	immediate = {
		set_global_flag = tec_allow_cui
	}
}

planet_event = { # Hydrological recalc
	id = tec_misc.3
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		has_deposit = d_tec_desiccators_deposit
	}

	immediate = {
		FROMFROM = {
			tec_calculate_hydrological_current_deposits = yes
		}
		FROM = {
			tec_calculate_hydrological_current_deposits = yes
		}
	}

}

event = {
	id = tec_misc.4
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		every_country = {
			every_owned_planet = {
				validate_planet_buildings_and_districts = yes
			}
			calculate_modifier = yes
		}
	}

}

# This = released vassal
# From = overlord
country_event = {
	id = tec_misc.5
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		set_country_flag = tec_sector_released_by_@from
	}
}


country_event = {
	id = tec_misc.6
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		is_ai = yes
		tec_is_default_country = yes
		OR = {
			tec_has_enough_ethic_points = no
			AND = {
				is_gestalt = yes
				tec_has_any_regular_ethics = yes
			}
			AND = {
				is_gestalt = no
				tec_has_any_gestalt_ethics = yes
			}
		}
	}

	immediate = {
		if = {
			limit = {
				is_gestalt = yes
			}
			tec_country_remove_regular_ethics = yes
			while = {
				limit = {
					tec_has_enough_ethic_points = no
				}
				random_list = {
					1 = {
						modifier = {
							mult = 0
							has_ethic = ethic_gestalt_overconsumption
						}
						modifier = {
							mult = 0
							OR = {
								has_civic = civic_tec_origin_replace_fruitful_hive
								has_civic = civic_tec_origin_gaia_affinity
								has_civic = civic_tec_origin_gaia_children
								has_civic = civic_tec_machine_idyllic_bloom
								has_civic = civic_hive_idyllic_bloom
							}
						}
						country_add_ethic = ethic_gestalt_overconsumption
					}
					1 = {
						modifier = {
							mult = 0
							has_ethic = ethic_gestalt_preservation
						}

						modifier = {
							mult = 1000
							OR = {
								has_civic = civic_tec_machine_terraformers
							}
						}
						country_add_ethic = ethic_gestalt_preservation
					}
					1 = {
						modifier = {
							mult = 0
							has_ethic = ethic_gestalt_empathy
						}
						modifier = {
							mult = 0
							OR = {
								has_civic = civic_hive_devouring_swarm
								has_civic = civic_machine_terminator
								has_civic = civic_machine_assimilator
								has_civic = civic_tec_hive_necrophage
								has_civic = civic_tec_hive_mindflayers
								has_civic = civic_tec_machine_promethean
							}
						}

						modifier = {
							mult = 1000
							OR = {
								has_civic = civic_tec_origin_replace_fruitful_hive
								has_civic = civic_tec_machine_cooperators

							}
						}
						country_add_ethic = ethic_gestalt_empathy
					}
					1 = {
						modifier = {
							mult = 0
							has_ethic = ethic_gestalt_apathy
						}
						modifier = {
							mult = 0
							OR = {
								has_civic = civic_hive_devouring_swarm
								has_civic = civic_machine_terminator
								has_civic = civic_machine_assimilator
								has_civic = civic_tec_hive_symbiotic
							}
						}

						modifier = {
							mult = 1000
							OR = {
								has_civic = civic_tec_machine_convergence
							}
						}
						country_add_ethic = ethic_gestalt_apathy
					}
					1 = {
						modifier = {
							mult = 0
							has_ethic = ethic_gestalt_extrospective
						}
						country_add_ethic = ethic_gestalt_extrospective
					}
					1 = {
						modifier = {
							mult = 0
							has_ethic = ethic_gestalt_introspective
						}
						country_add_ethic = ethic_gestalt_introspective
					}
				}
			}
			change_government = {
				cooldown = no
				remove_invalid_civics = yes
			}
		} else = {
			tec_country_remove_gestalt_ethics = yes

			if = {
				limit = {
					tec_has_enough_ethic_points = no
					has_civic = civic_fanatic_purifiers
					NOT = { has_valid_civic = civic_fanatic_purifiers }
				}
				if = {
					limit = {
						NOT = { has_ethic = ethic_fanatic_xenophobe }
					}
					while = {
						limit = {
							tec_has_enough_ethic_points = no
							NOT = { has_ethic = ethic_fanatic_xenophobe }
						}
						shift_ethic = ethic_xenophobe
					}
				}
				if = {
					limit = {
						tec_has_enough_ethic_points = no
						NOR = {
							is_militarist = yes
							is_spiritualist = yes
						}
					}
					random_list = {
						1 = { shift_ethic = ethic_militarist }
						1 = { shift_ethic = ethic_spiritualist }
					}
				}
			}

			if = {
				limit = {
					tec_has_enough_ethic_points = no
					OR = {
						has_civic = civic_sovereign_guardianship
						has_civic = civic_corporate_sovereign_guardianship
					}
					is_sovereign_guardianship_empire = no
				}
				shift_ethic = ethic_militarist
			}

			if = {
				limit = {
					tec_has_enough_ethic_points = no
					has_civic = civic_barbaric_despoilers
					NOT = { has_valid_civic = civic_barbaric_despoilers }
				}

				if = {
					limit = {
						is_militarist = no
					}
					shift_ethic = ethic_militarist
				}

				if = {
					limit = {
						is_xenophile = yes
					}
					shift_ethic = ethic_xenophobe
				}
				else_if = {
					limit = {
						tec_has_enough_ethic_points = no
						NOR = {
							is_xenophobe = yes
							is_authoritarian = yes
						}
					}
					random_list = {
						1 = {
							shift_ethic = ethic_xenophobe
						}
						1 = {
							modifier = {
								mult = 0
								is_democratic_authority = yes
							}
							shift_ethic = ethic_authoritarian
						}
					}
				}
			}

			if = {
				limit = {
					tec_has_enough_ethic_points = no
					has_civic = civic_tec_corporate_cooperacorp
					NOT = { has_valid_civic = civic_tec_corporate_cooperacorp }
				}
				if = {
					limit = {
						is_pacifist = no
					}
					shift_ethic = ethic_pacifist
				}
				if = {
					limit = {
						tec_has_enough_ethic_points = no
						is_xenophile = no
					}
					shift_ethic = ethic_xenophile
				}
			}

			if = {
				limit = {
					tec_has_enough_ethic_points = no
					has_civic = civic_tec_origin_replace_fruitful
					NOT = { has_valid_civic = civic_tec_origin_replace_fruitful }
				}
				random_list = {
					1 = {
						shift_ethic = ethic_xenophile
					}
					1 = {
						shift_ethic = ethic_pacifist
					}
				}
			}

			if = {
				limit = {
					tec_has_enough_ethic_points = no
					has_civic = civic_tec_origin_gaia_affinity
					NOT = { has_valid_civic = civic_tec_origin_gaia_affinity }
					is_industrialist = yes
				}
				shift_ethic = ethic_ecologist
			}

			if = {
				limit = {
					tec_has_enough_ethic_points = no
					has_civic = civic_tec_origin_gaia_children
					NOT = { has_valid_civic = civic_tec_origin_gaia_children }
					is_industrialist = yes
				}
				shift_ethic = ethic_ecologist
			}

			if = {
				limit = {
					tec_has_enough_ethic_points = no
					has_civic = civic_tec_origin_mecha_automation
					NOT = { has_valid_civic = civic_tec_origin_mecha_automation }
					is_industrialist = no
				}
				shift_ethic = ethic_industrialist
			}


			while = {
				limit = {
					tec_has_enough_ethic_points = no
				}
				ordered_pop_faction = {
					limit = {
						inline_script = {
							script = iterators/tec_iterate_ethic_regular
							code = "
								if = {
									limit = {
										has_ethic = ethic_$ethic$
									}
									prev = {
										NOT = { has_ethic = ethic_fanatic_$ethic$ }
										is_$opposing_ethic$ = no
									}
								}
							"
						}
					}
					order_by = trigger:support
					position = 0

					inline_script = {
						script = iterators/tec_iterate_ethic_regular
						code = "
							if = {
								limit = {
									has_ethic = ethic_$ethic$
								}
								prev = { shift_ethic = ethic_$ethic$ }
							}
						"
					}
				}
			}

			change_government = {
				cooldown = no
				remove_invalid_civics = yes
			}
		}
	}
}


namespace = tec_caching

# on_game_start
# on_yearly_pulse
event = { # General caching, run once 
	id = tec_caching.1
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		NOT = {
			has_global_flag = tec_cached_month
		}
	}

	immediate = {
		tec_cache_everything = yes
		set_timed_global_flag = { flag = tec_cached_month days = 30 }
	}
}

# on_colonize
# on_planet_class_changes
# on_planet_transfer
planet_event = { # cache planet triggers
	id = tec_caching.2
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		tec_cache_planet_type_triggers = { force = yes }
	}
}

# on_colonize
# on_building_complete
# on_building_upgraded
# on_planet_transfer
planet_event = { # cache building triggers
	id = tec_caching.3
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		tec_cache_capital_triggers = { force = yes }
		tec_cache_building_triggers = { force = yes }
		tec_cache_combined_values = { force = yes }
	}
}

# on_tech
# on_policy_change
country_event = { # shackled pop cache triggers
	id = tec_caching.4
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		every_owned_pop = {
			tec_cache_shackled_triggers = { force = yes }
		}
	}
}

# on_monthly_pulse
event = {
	id = tec_caching.5 # montly
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		NOT = {
			has_global_flag = tec_cached_month
		}
	}
	
	immediate = {
		every_country = {
			every_owned_planet = {
				tec_cache_colony_triggers = yes
			}
			tec_cache_opinions = yes
			# in case some might use opinion mods
			country_event = {
				id = tec_caching.9 
			}
		}
		every_galaxy_pop = {
			limit = { exists = this }
			tec_cache_pop_triggers = yes
		}
		set_timed_global_flag = { flag = tec_cached_month days = 30 }
	}
}

# on_post_government_changed
country_event = {
	id = tec_caching.6
	hide_window = yes
	is_triggered_only = yes
	
	immediate = {
		tec_cache_country_civic_triggers = { force = yes }
	}
}

country_event = {
	id = tec_caching.7
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		every_galaxy_planet = {
			limit = {
				OR = {
					is_colony = yes
					is_colonizable = yes
				}
			}
			tec_cache_planet_type_triggers = { force = yes }
			if = {
				limit = {
					is_colony = yes
				}
				tec_cache_colony_triggers = { force = yes }
				tec_cache_capital_triggers = { force = yes }
				tec_cache_building_triggers = { force = yes }
				tec_cache_combined_values = { force = yes }
			}
		}
		every_galaxy_pop = {
			limit = { exists = this }
			tec_cache_shackled_triggers = { force = yes }
			tec_cache_pop_triggers = { force = yes }
		}
		every_galaxy_species = {
			tec_cache_species_traits_triggers = { force = yes }
		}
		every_country = {
			tec_cache_country_civic_triggers = { force = yes }
			tec_cache_opinions = { force = yes }
			# in case some might use opinion mods
			country_event = {
				id = tec_caching.9 
			}
		}
		set_global_flag = @tec_cache_global_flag
	}
}

# on_modification_complete
country_event = {
	id = tec_caching.8
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		from = { tec_cache_species_traits_triggers = { force = yes } }
	}
}

country_event = { # defer to have correct root scope
	id = tec_caching.9 
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		tec_cache_country_monthly_triggers = yes
	}
}

# on_district_complete
# on_district_demolished
planet_event = { # cache building triggers
	id = tec_caching.10
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		tec_cache_combined_values = { force = yes }
	}
}


pop_event = { # cache pop triggers
	id = tec_caching.11
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		tec_cache_pop_triggers = { force = yes }
		tec_cache_shackled_triggers = { force = yes }
	}
}


namespace = tec_debug

leader_event = {
	id = tec_debug.1
	title = "tec_debug.1.name"
	desc = "tec_debug.1.desc"
	show_sound = par_portrait_01
	is_triggered_only = yes

	picture = GFX_leader_recruitment_bg_renowned
	auto_opens = yes

	event_window_type = leader_recruit

	picture_event_data = {
		portrait = event_target:tec_debug_leader
		room = machine_room
	}

	option = {
		name = DISMISS
		tag = dismiss_leader
	}

	option = {
		name = DISMISS
		tag = hire_leader
	}

	option = {
		name = tec_debug.1.kill_leader
		event_target:tec_debug_leader = {
			kill_leader = {
				show_notification = no
			}
		}
	}

	option = {
		name = tec_debug.1.fire_leader
		event_target:tec_debug_leader = {
			kill_leader = {
				fire = yes
				show_notification = no
			}
		}
	}

	option = {
		name = tec_debug.1.increase_skill
		event_target:tec_debug_leader = {
			add_skill_without_trait_selection = 1
			leader_event = {
				id = tec_debug.1
			}
		}
	}

	option = {
		name = tec_debug.1.random_trait
		event_target:tec_debug_leader = {
			add_trait_no_notify = random_common
			leader_event = {
				id = tec_debug.1
			}
		}
	}

	option = {
		name = tec_debug.1.remove_negatives
		event_target:tec_debug_leader = {
			remove_all_negative_traits = yes
			leader_event = {
				id = tec_debug.1
			}
		}
	}

	option = {
		name = tec_debug.1.rerun_leader_actions
		event_target:tec_debug_leader = {
			set_leader_flag = tec_force_starting_actions
			tec_leader_handle_starting_modifiers = {
				from = owner
			}
			remove_leader_flag = tec_force_starting_actions
			leader_event = {
				id = tec_debug.1
			}
		}
	}

	option = {
		name = tec_debug.1.reset_leader
		event_target:tec_debug_leader = {
			if = {
				limit = {
					tec_is_aiauth_councilor_node = yes
					is_ruler = yes
				}
				set_leader_flag = tec_debug_leader_was_ainode_ruler
			}
			if = {
				limit = {
					tec_is_aiauth_councilor_node = yes
					is_ruler = no
				}
				set_leader_flag = tec_debug_leader_was_ainode_councilor
			}
			if = {
				limit = {
					tec_is_aiauth_planetary_governing_node = yes
				}
				set_leader_flag = tec_debug_leader_was_ainode_governor
			}
			remove_all_traits = yes
			set_skill = 1
			add_trait_no_notify = "random_common"
			set_leader_flag = tec_force_starting_actions
			clear_variable = tec_leader_starting_traits_modifier
			if = {
				limit = {
					has_leader_flag = tec_debug_leader_was_ainode_ruler
				}
				add_trait_no_notify = leader_trait_tec_aiauth_ruler
				tec_leader_add_councilor_trait = yes
			}
			if = {
				limit = {
					has_leader_flag = tec_debug_leader_was_ainode_councilor
				}
				add_trait_no_notify = leader_trait_tec_aiauth_node
				tec_leader_add_councilor_trait = yes
			}
			if = {
				limit = {
					has_leader_flag = tec_debug_leader_was_ainode_governor
				}
				add_trait_no_notify = leader_trait_tec_aiauth_planetary_governing_node
				tec_leader_add_governor_trait = yes
			}
			tec_leader_handle_starting_modifiers = {
				from = owner
			}
			remove_leader_flag = tec_force_starting_actions
			leader_event = {
				id = tec_debug.1
			}
		}
	}
}