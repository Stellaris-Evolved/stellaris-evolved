# common\scripted_effects\zz_evolved_scripted_effects.txt

tec_cache = {
	inline_script = {
		script = tec_type_hint
		flag_scope_type = $scope$
		scripted_trigger = $trigger$
		scope = $scope_redirect$
	}

	optimize_memory
	if = {
		limit = {
			[[scope_redirect]
				exists = $scope_redirect$
				$scope_redirect$ = {
					$trigger$ = yes
				}
			]
			[[!scope_redirect]
				$trigger$ = yes
			]
		}
		
		set_$scope$_flag = tec_cache_$trigger$
	} else = {
		remove_$scope$_flag = tec_cache_$trigger$
	}
}

tec_cache_value = {
	inline_script = {
		script = tec_type_hint
		script_value = $value$
	}

	optimize_memory
	set_variable = {
		which = tec_cache_$value$
		value = value:$value$
	}
}

tec_cache_planet_type_triggers = {
	optimize_memory
	inline_script = {
		script = tec_type_hint
		[[force] [[force] bool = $force$ ] ]
	}
	[[!force]
		if = {
			limit = { NOT = { has_planet_flag = tec_cache_planet_type_triggers_done } }
	]
	tec_cache = {
		scope = planet
		trigger = tec_is_arcology
	}
	tec_cache = {
		scope = planet
		trigger = tec_is_space_arcology
	}
	tec_cache = {
		scope = planet
		trigger = tec_is_habitat
	}
	tec_cache = {
		scope = planet
		trigger = tec_is_ringworld
	}
	tec_cache = {
		scope = planet
		trigger = tec_is_elysium
	}
	tec_cache = {
		scope = planet
		trigger = tec_is_city_world
	}
	tec_cache = {
		scope = planet
		trigger = tec_is_perfect_planet
	}
	tec_cache = {
		scope = planet
		trigger = tec_is_neutral_planet
	}

	tec_cache = {
		scope = planet
		trigger = tec_has_all_slots_unlocked
	}

	# planet job swaps

	tec_cache = {
		scope = planet
		trigger = tec_pd_has_crucible_foundry
	}
	tec_cache = {
		scope = planet
		trigger = tec_has_foundry_planet_swap
	}

	tec_cache = {
		scope = planet
		trigger = tec_has_scrap_miner
	}
	tec_cache = {
		scope = planet
		trigger = tec_has_matter_miner
	}
	tec_cache = {
		scope = planet
		trigger = tec_has_miner_planet_swap
	}

	tec_cache = {
		scope = planet
		trigger = tec_mining_aqua_district_swap
		scope_redirect = owner
	}

	tec_cache = {
		scope = planet
		trigger = tec_has_miner_swap
		scope_redirect = owner
	}

	tec_cache = {
		scope = planet
		trigger = tec_has_farmer_planet_swap
	}

	tec_cache = {
		scope = planet
		trigger = tec_farming_aqua_district_swap
		scope_redirect = owner
	}

	tec_cache = {
		scope = planet
		trigger = tec_has_farmer_swap
		scope_redirect = owner
	}

	tec_cache = {
		scope = planet
		trigger = tec_has_technician_swap
		scope_redirect = owner
	}

	tec_cache = {
		scope = planet
		trigger = tec_generator_aqua_district_swap
		scope_redirect = owner
	}

	tec_cache = {
		scope = planet
		trigger = tec_has_technician_planet_swap
	}

	tec_cache = {
		scope = planet
		trigger = tec_has_clerk_planet_swap
	}

	tec_cache = {
		scope = planet
		trigger = tec_has_colonist_half_planet_swap
	}

	tec_cache = {
		scope = planet
		trigger = tec_has_soldier_planet_swap
	}

	tec_cache = {
		scope = planet
		trigger = tec_has_ruler_planet_swap
	}

	inline_script = {
		script = mod_support/tec_effect_include
		effect = tec_cache_planet_type_triggers
		parameters = ""
	}

	set_timed_planet_flag = {
		flag = tec_cache_planet_type_triggers_done
		days = 30
	}

	[[!force]
		}
	]
}

tec_cache_capital_triggers = {
	optimize_memory
	inline_script = {
		script = tec_type_hint
		[[force] bool = $force$ ]
	}
	[[!force]
		if = {
			limit = { NOT = { has_planet_flag = tec_cache_capital_triggers_done } }
	]
	tec_cache = {
		scope = planet
		trigger = tec_has_t1_capital
	}
	tec_cache = {
		scope = planet
		trigger = tec_has_t2_capital
	}
	tec_cache = {
		scope = planet
		trigger = tec_has_t3_capital
	}
	tec_cache = {
		scope = planet
		trigger = tec_has_t4_capital
	}
	tec_cache = {
		scope = planet
		trigger = tec_has_t5_capital
	}
	tec_cache = {
		scope = planet
		trigger = tec_has_imperial_capital
	}
	tec_cache_value = {
		value = tec_capital_tier
	}
	tec_cache_value = {
		value = tec_capital_tier_generic_scaling
	}

	inline_script = {
		script = mod_support/tec_effect_include
		effect = tec_cache_capital_triggers
		parameters = ""
	}

	set_timed_planet_flag = {
		flag = tec_cache_capital_triggers_done
		days = 30
	}

	[[!force]
		}
	]
}

tec_cache_building_triggers = {
	optimize_memory

	inline_script = {
		script = tec_type_hint
		[[force] bool = $force$ ]
	}
	[[!force]
		if = {
			limit = { NOT = { has_planet_flag = tec_cache_building_triggers_done } }
	]

	inline_script = {
		script = mod_support/tec_effect_include
		effect = tec_cache_building_triggers
		parameters = ""
	}

	set_timed_planet_flag = {
		flag = tec_cache_building_triggers_done
		days = 30
	}

	[[!force]
		}
	]
}

tec_cache_combined_values = {
	optimize_memory

	inline_script = {
		script = tec_type_hint
		[[force] bool = $force$ ]
	}
	[[!force]
		if = {
			limit = { NOT = { has_planet_flag = tec_cache_combined_values_done } }
	]

	tec_cache_value = {
		value = farming_combined_value
	}
	tec_cache_value = {
		value = mining_combined_value
	}
	tec_cache_value = {
		value = generator_combined_value
	}
	tec_cache_value = {
		value = research_combined_value
	}
	tec_cache_value = {
		value = unity_combined_value
	}
	tec_cache_value = {
		value = refinery_combined_value
	}
	tec_cache_value = {
		value = trade_combined_value
	}
	tec_cache_value = {
		value = military_combined_value
	}

	inline_script = {
		script = mod_support/tec_effect_include
		effect = tec_cache_combined_values
		parameters = ""
	}

	set_timed_planet_flag = {
		flag = tec_cache_combined_values_done
		days = 30
	}

	[[!force]
		}
	]
}

tec_cache_colony_triggers = {
	optimize_memory

	inline_script = {
		script = tec_type_hint
		[[force] bool = $force$ ]
	}
	[[!force]
		if = {
			limit = { NOT = { has_planet_flag = tec_cache_colony_triggers_done } }
	]


	tec_cache = {
		scope = planet
		trigger = tec_has_special_ruler_feature
	}
	tec_cache = {
		scope = planet
		trigger = tec_planet_selective_kinship_likes
	}
	tec_cache = {
		scope = planet
		trigger = tec_planet_selective_kinship_hates
	}
	tec_cache = {
		scope = planet
		trigger = tec_planet_allows_automation
	}

	tec_cache = {
		scope = planet
		trigger = tec_planet_prosperity_gospel_check_trigger
	}

	if = {
		limit = {
			has_global_flag = galactic_community_resolution_divinity_right_to_work
		}
		tec_cache = {
			scope = planet
			trigger = tec_planet_divinity_right_to_work_job_check_trigger_ruler
		}
		tec_cache = {
			scope = planet
			trigger = tec_planet_divinity_right_to_work_job_check_trigger_specialist
		}
		tec_cache = {
			scope = planet
			trigger = tec_planet_divinity_right_to_work_job_check_trigger_worker
		}
	}


	inline_script = {
		script = mod_support/tec_effect_include
		effect = tec_cache_colony_triggers
		parameters = ""
	}


	set_timed_planet_flag = {
		flag = tec_cache_colony_triggers_done
		days = 30
	}

	[[!force]
		}
	]
}

tec_cache_planet_scope_triggers = {
	inline_script = {
		script = tec_type_hint
		[[force] bool = $force$ ]
	}
	optimize_memory
	tec_cache_planet_type_triggers = { force = $force|no$ }
	tec_cache_capital_triggers = { force = $force|no$ }
	tec_cache_building_triggers = { force = $force|no$ }
	tec_cache_colony_triggers = { force = $force|no$ }
	tec_cache_combined_values = { force = $force|no$ }
}

tec_cache_shackled_triggers = {
	optimize_memory
	inline_script = {
		script = tec_type_hint
		[[force] bool = $force$ ]
	}
	[[!force]
		if = {
			limit = { NOT = { has_pop_flag = tec_cache_shackled_triggers_done } }
	]

	tec_cache = {
		scope = pop
		trigger = tec_is_shackled_robot
	}
	tec_cache = {
		scope = pop
		trigger = tec_is_non_sapient_robot
	}
	tec_cache = {
		scope = pop
		trigger = tec_is_shackled_bioservant
	}

	tec_cache = {
		scope = pop
		trigger = tec_is_non_sapient_bioservant
	}

	set_timed_pop_flag = {
		flag = tec_cache_shackled_triggers_done
		days = 30
	}

	[[!force]
		}
	]
}


tec_cache_pop_triggers = {
	optimize_memory

	inline_script = {
		script = tec_type_hint
		[[force] bool = $force$ ]
	}
	[[!force]
		if = {
			limit = { NOT = { has_pop_flag = tec_cache_pop_triggers_done } }
	]

	tec_cache = {
		scope = pop
		trigger = tec_purge_pop_category_trigger
	}
	tec_cache = {
		scope = pop
		trigger = tec_has_stapled_trait
	}
	tec_cache = {
		scope = pop
		trigger = tec_ecocat_planet_jobs_slave
	}
	tec_cache = {
		scope = pop
		trigger = tec_ecocat_planet_jobs_worker
	}
	tec_cache = {
		scope = pop
		trigger = tec_ecocat_planet_jobs_worker_only
	}
	tec_cache = {
		scope = pop
		trigger = tec_ecocat_planet_jobs_specialist
	}
	tec_cache = {
		scope = pop
		trigger = tec_ecocat_planet_jobs_specialist_only
	}
	tec_cache = {
		scope = pop
		trigger = tec_ecocat_planet_jobs_simple_drone
	}
	tec_cache = {
		scope = pop
		trigger = tec_ecocat_planet_jobs_complex_drone
	}
	tec_cache = {
		scope = pop
		trigger = battle_thrall_job_check_trigger
	}
	tec_cache = {
		scope = pop
		trigger = entertainer_job_check_trigger
	}
	tec_cache = {
		scope = pop
		trigger = complex_specialist_job_check_trigger
	}

	tec_cache = {
		scope = pop
		trigger = can_fill_ruler_job_trigger
	}
	tec_cache = {
		scope = pop
		trigger = can_fill_specialist_job_trigger
	}
	tec_cache = {
		scope = pop
		trigger = can_fill_worker_job_trigger
	}
	tec_cache = {
		scope = pop
		trigger = tec_pop_generates_crime_trigger
	}
	if = {
		limit = {
			# shortcut, need to check what happens with democracy
			exists = pop_faction
		}
		tec_cache = {
			scope = pop
			trigger = tec_can_vote_in_democratic_election_trigger
		}
	}

	inline_script = {
		script = mod_support/tec_effect_include
		effect = tec_cache_pop_triggers
		parameters = ""
	}


	set_timed_pop_flag = {
		flag = tec_cache_pop_triggers_done
		days = 30
	}

	[[!force]
		}
	]
}

tec_cache_species_traits_triggers = {
	optimize_memory
	inline_script = {
		script = tec_type_hint
		[[force] bool = $force$ ]
	}
	[[!force]
		if = {
			limit = { NOT = { has_species_flag = tec_cache_species_traits_triggers_done } }
	]
	tec_cache = {
		scope = species
		trigger = tec_has_stapled_trait
	}

	tec_cache = {
		scope = species
		trigger = tec_has_ruler_job_invalidation_trait
	}
	tec_cache = {
		scope = species
		trigger = tec_has_specialist_job_invalidation_trait
	}
	tec_cache = {
		scope = species
		trigger = tec_has_blocked_leader_trait
	}

	tec_cache = {
		scope = species
		trigger = tec_is_total_psionic_species
	}

	inline_script = {
		script = mod_support/tec_effect_include
		effect = tec_cache_species_traits_triggers
		parameters = ""
	}

	set_timed_species_flag = {
		flag = tec_cache_species_traits_triggers_done
		days = 30
	}

	[[!force]
		}
	]
}

tec_cache_country_monthly_triggers = {
	optimize_memory
	inline_script = {
		script = tec_type_hint
		[[force] bool = $force$ ]
	}
	[[!force]
		if = {
			limit = { NOT = { has_country_flag = tec_cache_country_monthly_triggers_done } }
	]
	if = {
		limit = {
			tec_is_default_country = yes
			is_regular_empire = yes
		}
		tec_cache = {
			scope = country
			trigger = tec_xeno_any_genocided_our_species
		}
		tec_cache = {
			scope = country
			trigger = tec_xeno_we_genocided_any
		}
		tec_cache = {
			scope = country
			trigger = tec_xeno_any_enslaved_us
		}
		tec_cache = {
			scope = country
			trigger = tec_militarist_any_own_our_planets
		}
		tec_cache = {
			scope = country
			trigger = tec_found_guardian
		}
		tec_cache = {
			scope = country
			trigger = tec_is_xenophage
		}

		# values
		tec_cache_value = {
			value = authoritarian_ethics_from_relations
		}
		tec_cache_value = {
			value = egalitarian_ethics_from_relations
		}
		tec_cache_value = {
			value = xenophobe_ethics_from_relations
		}
		tec_cache_value = {
			value = xenophile_ethics_from_relations
		}
		tec_cache_value = {
			value = spiritualist_ethics_from_relations
		}
		tec_cache_value = {
			value = materialist_ethics_from_relations
		}
		tec_cache_value = {
			value = pacifist_ethics_from_pacts
		}
		tec_cache_value = {
			value = tec_cooperative_ethics_from_relations
		}
		tec_cache_value = {
			value = tec_competitive_ethics_from_relations
		}

		every_owned_species = {
			if = {
				limit = {
					tec_species_in_country_other_are_free_xenos = {
						country = prev
					}
				}
				set_species_flag = tec_cache_tec_species_in_country_other_are_free_xenos@prev
			}
		}
	}

	inline_script = {
		script = mod_support/tec_effect_include
		effect = tec_cache_country_monthly_triggers
		parameters = ""
	}

	set_timed_country_flag = {
		flag = tec_cache_country_monthly_triggers_done
		days = 30
	}

	[[!force]
		}
	]
}

# This is separate to be able to update only when needed
tec_cache_country_civic_triggers = {
	optimize_memory
	inline_script = {
		script = tec_type_hint
		[[force] bool = $force$ ]
	}
	[[!force]
		if = {
			limit = { NOT = { has_country_flag = tec_cache_country_civic_triggers_done } }
	]
	tec_cache = {
		scope = country
		trigger = tec_is_psychohistorian_researcher_empire
	}
	tec_cache = {
		scope = country
		trigger = tec_is_technomancer_researcher_empire
	}
	tec_cache = {
		scope = country
		trigger = tec_is_starseeker_researcher_empire
	}
	tec_cache = {
		scope = country
		trigger = tec_is_psi_researcher_empire
	}
	tec_cache = {
		scope = country
		trigger = tec_is_bio_researcher_empire
	}
	tec_cache = {
		scope = country
		trigger = tec_is_mecha_researcher_empire
	}
	tec_cache = {
		scope = country
		trigger = tec_is_labrat_researcher_empire
	}
	tec_cache = {
		scope = country
		trigger = tec_is_diversifier_researcher_empire
	}
	tec_cache = {
		scope = country
		trigger = tec_is_astrologer_researcher_empire
	}
	tec_cache = {
		scope = country
		trigger = tec_is_singularity_researcher_empire
	}
	tec_cache = {
		scope = country
		trigger = tec_is_special_researcher_empire
	}
	tec_cache = {
		scope = country
		trigger = tec_replaces_half_researcher_empire
	}
	# Cults
	tec_cache = {
		scope = country
		trigger = tec_is_death_cult
	}
	tec_cache = {
		scope = country
		trigger = tec_is_machine_cult
	}
	tec_cache = {
		scope = country
		trigger = tec_is_occult_cult
	}
	tec_cache = {
		scope = country
		trigger = tec_is_paperwork_cult
	}
	tec_cache = {
		scope = country
		trigger = tec_is_starseeker_cult
	}
	tec_cache = {
		scope = country
		trigger = tec_is_atom_cult
	}
	tec_cache = {
		scope = country
		trigger = tec_is_cycle_cult
	}
	tec_cache = {
		scope = country
		trigger = tec_is_wealth_cult
	}
	tec_cache = {
		scope = country
		trigger = tec_is_paranormal_cult
	}
	tec_cache = {
		scope = country
		trigger = tec_is_butlerian_cult
	}
	tec_cache = {
		scope = country
		trigger = tec_is_spiritualist_main_cult
	}
	tec_cache = {
		scope = country
		trigger = tec_is_spiritualist_secondary_cult
	}
	# Ruler
	tec_cache = {
		scope = country
		trigger = tec_has_ruler_civic_regular
	}
	tec_cache = {
		scope = country
		trigger = tec_has_ruler_civic_mega
	}
	tec_cache = {
		scope = country
		trigger = tec_has_ruler_civic
	}

	tec_cache = {
		scope = country
		trigger = tec_has_ruler_civic_hive
	}
	tec_cache = {
		scope = country
		trigger = tec_has_maintenance_drone_swap_civic_hive
	}

	tec_cache = {
		scope = country
		trigger = tec_has_ruler_civic_machine
	}
	tec_cache = {
		scope = country
		trigger = tec_has_directive_civic_machine
	}
	tec_cache = {
		scope = country
		trigger = tec_has_maintenance_drone_swap_civic_machine
	}
	# Swaps

	tec_cache = {
		scope = country
		trigger = tec_has_entertainer_swap
	}
	tec_cache = {
		scope = country
		trigger = tec_has_healthcare_swap
	}
	tec_cache = {
		scope = country
		trigger = tec_has_enforcer_swap
	}
	tec_cache = {
		scope = country
		trigger = tec_has_colonist_swap
	}
	tec_cache = {
		scope = country
		trigger = tec_has_colonist_half_swap
	}
	tec_cache = {
		scope = country
		trigger = tec_has_clerk_swap
	}
	tec_cache = {
		scope = country
		trigger = tec_has_coordinator_swap
	}
	tec_cache = {
		scope = country
		trigger = tec_has_soldier_swap
	}
	tec_cache = {
		scope = country
		trigger = tec_has_maintenance_swap
	}
	tec_cache = {
		scope = country
		trigger = tec_has_patrol_drone_swap
	}
	tec_cache = {
		scope = country
		trigger = tec_has_warrior_drone_swap
	}

	tec_cache = {
		scope = country
		trigger = tec_uses_regular_empire_jobs
	}

	# Types
	tec_cache = {
		scope = country
		trigger = tec_is_dystopian_empire
	}

	tec_cache = {
		scope = country
		trigger = tec_is_selective_kinship_empire
	}
	# politician swaps
	tec_cache = {
		scope = country
		trigger = tec_country_has_politician_ruler
	}

	tec_cache = {
		scope = country
		trigger = tec_country_has_tec_ai_computator_ruler
	}

	tec_cache = {
		scope = country
		trigger = tec_country_has_tec_ai_high_ordinator_ruler
	}

	tec_cache = {
		scope = country
		trigger = tec_country_has_executive_ruler
	}

	tec_cache = {
		scope = country
		trigger = tec_country_has_steward_ruler
	}

	inline_script = {
		script = mod_support/tec_effect_include
		effect = tec_cache_country_civic_triggers
		parameters = ""
	}

	set_timed_country_flag = {
		flag = tec_cache_country_civic_triggers_done
		days = 30
	}

	[[!force]
		}
	]
}

# scope: country
tec_cache_opinions = {
	optimize_memory
	inline_script = {
		script = tec_type_hint
		[[force] bool = $force$ ]
	}
	[[!force]
		if = {
			limit = { NOT = { has_country_flag = tec_cache_opinions_done } }
	]
	if = {
		limit = {
			OR = {
				tec_is_default_country = yes
				is_fallen_empire = yes
			}
		}
		every_spynetwork = {
			limit = {
				target = {
					has_established_contact = prevprev
					OR = {
						tec_is_default_country = yes
						is_fallen_empire = yes
					}
				}
			}
			target = {
				set_variable = {
					which = tec_cache_tec_opinion
					value = 0
				}
				set_variable = {
					which = tec_cache_tec_their_opinion
					value = 0
				}
				export_trigger_value_to_variable = { # we reverse them due to using this on target
					variable = tec_cache_tec_opinion
					trigger = their_opinion
					parameters = { who = prevprev }
				}
				export_trigger_value_to_variable = {
					variable = tec_cache_tec_their_opinion
					trigger = opinion
					parameters = { who = prevprev }
				}
			}
			set_variable = {
				which = tec_cache_tec_opinion
				value = target.tec_cache_tec_opinion
			}
			set_variable = {
				which = tec_cache_tec_their_opinion
				value = target.tec_cache_tec_their_opinion
			}
			set_variable = {
				which = tec_cache_tec_opinion_total
				value = tec_cache_tec_opinion
			}
			change_variable = {
				which = tec_cache_tec_opinion_total
				value = tec_cache_tec_their_opinion
			}
		}
	}
	set_timed_country_flag = {
		flag = tec_cache_opinions_done
		days = 30
	}

	[[!force]
		}
	]
}

tec_cache_everything = {
	optimize_memory
	random_country = {
		country_event = {
			id = tec_caching.7
		}
	}
}

tec_hoarders_recover_resource = {
	inline_script = {
		script = tec_type_hint
		resource = $RESOURCE$
	}

	if = {
		limit = {
			is_variable_set = tec_$RESOURCE$_stockpile
		}
		set_variable = {
			which = tec_$RESOURCE$_recovered
			value = tec_$RESOURCE$_stockpile
		}
		divide_variable = {
			which = tec_$RESOURCE$_recovered
			value = 2
		}
		owner = {
			add_resource = {
				$RESOURCE$ = 1
				mult = prev.tec_$RESOURCE$_recovered
			}
		}
		clear_variable = tec_$RESOURCE$_stockpile
	} else = {
		set_variable = {
			which = tec_$RESOURCE$_recovered
			value = 0
		}
	}
}

tec_hoarders_withdraw_resource = {
	inline_script = {
		script = tec_type_hint
		resource = $RESOURCE$
	}

	if = {
		limit = {
			is_variable_set = tec_$RESOURCE$_stockpile
		}
		owner = {
			add_resource = {
				$RESOURCE$ = 1
				mult = prev.tec_$RESOURCE$_stockpile
			}
		}
		clear_variable = tec_$RESOURCE$_stockpile
	}
}

tec_hoarders_deposit_max_resource = {
	inline_script = {
		script = tec_type_hint
		resource = $RESOURCE$
	}
	if = {
		limit = {
			owner = {
				resource_income_compare = {
					resource = $RESOURCE$
					value >= 0
				}
			}
		}
		event_target:tec_hoarders_managed_planet = {
			set_planet_flag = tec_vault_manage_$RESOURCE$
			set_variable = {
				which = tec_stockpile_change
				value = 0
			}
			change_variable = {
				which = tec_stockpile_change
				value = value:tec_hoarders_max_that_can_be_deposited
			}
			tec_hoarders_manage_resource = { RESOURCE = $RESOURCE$ }
			remove_planet_flag = tec_vault_manage_$RESOURCE$
		}
	}
}


tec_hoarders_manage_resource = {
	inline_script = {
		script = tec_type_hint
		resource = $RESOURCE$
	}

	if = {
		limit = {
			has_planet_flag = tec_vault_manage_$RESOURCE$
		}
		event_target:tec_hoarders_managed_planet = {
			change_variable = {
				which = tec_$RESOURCE$_stockpile
				value = tec_stockpile_change
			}
			owner = {
				add_resource = {
					$RESOURCE$ = -1
					mult = prev.tec_stockpile_change
				}
			}
		}
	}
}

tec_terraformer_keeper_planet_deposit_effect = {
	random_list = {
		10 = {
			add_deposit = d_tec_sanctified_eco_grounds
		}
	}
}

tec_terraformer_keeper_arcology_deposit_effect = {
	random_list = {
		10 = {
			add_deposit = d_tec_sanctified_eco_grounds_ring
		}
	}
}

tec_terraformer_environmentalist_planet_deposit_effect = {
	random_list = {
		10 = {
			modifier = {
				factor = 0.5
				has_climate = wet
			}
			modifier = {
				factor = 1.25
				has_climate = cold
			}
			add_deposit = d_mountain_range
		}
		10 = {
			modifier = {
				factor = 1.25
				has_climate = dry
			}
			add_deposit = d_active_volcano
		}
		10 = {
			modifier = {
				factor = 0.5
				has_climate = cold
			}
			add_deposit = d_dangerous_wildlife_blocker
		}
		10 = {
			modifier = {
				factor = 0.5
				has_climate = dry
			}
			add_deposit = d_dense_jungle
		}
		10 = {
			modifier = {
				factor = 0.5
				has_climate = dry
			}
			modifier = {
				factor = 1.25
				has_climate = wet
			}
			add_deposit = d_toxic_kelp
		}
		10 = {
			modifier = {
				factor = 1.25
				has_climate = dry
			}
			add_deposit = d_deep_sinkhole
		}
		10 = {
			modifier = {
				factor = 1.25
				has_climate = dry
			}
			add_deposit = d_quicksand_basin
		}
		10 = {
			modifier = {
				factor = 1.25
				OR = {
					has_climate = wet
					has_climate = cold
				}
			}
			add_deposit = d_noxious_swamp
		}
		10 = {
			modifier = {
				factor = 0.5
				has_climate = dry
			}
			add_deposit = d_massive_glacier
		}
	}
}

tec_terraformer_environmentalist_arcology_deposit_effect = {
	random_list = {
		10 = {
			add_deposit = d_tec_preserved_eco_ring
		}
		10 = {
			add_deposit = d_tec_preserved_eco_ring_2
		}
	}
}

tec_terraformer_engineers_planet_deposit_effect = {
	random_list = {
		10 = {
			add_deposit = d_tec_eco_basin
		}
		10 = {
			add_deposit = d_tec_eco_glacier
		}
		10 = {
			add_deposit = d_tec_eco_jungle
		}
		10 = {
			add_deposit = d_tec_eco_kelp
		}
		10 = {
			add_deposit = d_tec_eco_mountains_range
		}
		10 = {
			add_deposit = d_tec_eco_sinkhole
		}
		10 = {
			add_deposit = d_tec_eco_swamp
		}
		10 = {
			add_deposit = d_tec_eco_volcano
		}
		10 = {
			add_deposit = d_tec_eco_wildlife_blocker
		}
	}
}

tec_terraformer_engineers_arcology_deposit_effect = {
	random_list = {
		10 = {
			add_deposit = d_tec_eco_synthetic_life
		}
		10 = {
			add_deposit = d_tec_eco_synthetic_volcano
		}
		10 = {
			add_deposit = d_tec_eco_synthetic_flora
		}
	}
}

tec_terraformer_preserver_planet_deposit_effect = {
	random_list = {
		10 = {
			add_deposit = d_tec_preserved_eco_ecology
		}
		10 = {
			add_deposit = d_tec_preserved_eco_mining
		}
		10 = {
			add_deposit = d_tec_preserved_eco_other
		}
	}
}

tec_terraformer_preserver_arcology_deposit_effect = {
	random_list = {
		10 = {
			add_deposit = d_tec_preserved_eco_ring
		}
		10 = {
			add_deposit = d_tec_preserved_eco_ring_2
		}
	}
}

tec_engineer_precursor_deposit_effect = {
	if = {
		limit = {
			this.solar_system = {
				any_system_planet = {
					OR = {
						has_planet_flag = precursor_world
						has_planet_flag = gpm_is_precursor_world
					}
				}
			}
		}
		add_deposit = d_tec_engineered_precursor
	}
}

tec_engineer_habitat_deposit_effect = {
	random_list = {
		10 = {
			modifier = {
				factor = 100
				has_trade_designation = yes
			}
			add_deposit = d_tec_engineered_hangar
		}
		10 = {
			modifier = {
				factor = 100
				has_foundry_designation = yes
			}
			add_deposit = d_tec_engineered_industrial
		}
		10 = {
			modifier = {
				factor = 100
				has_refinery_designation = yes
			}
			add_deposit = d_tec_engineered_refinery
			random_list = {
				10 = {
					set_planet_flag = tec_engineer_chemist_refinery
				}
				10 = {
					set_planet_flag = tec_engineer_gas_refiner_refinery
				}
				10 = {
					set_planet_flag = tec_engineer_translucer_refinery
				}
			}
		}
	}
}

tec_engineer_arcology_deposit_effect = {
	random_list = {
		10 = {	# Industrial
			modifier = {
				factor = 100
				OR = {
					has_industrial_designation = yes
					has_foundry_designation = yes
					has_factory_designation = yes
				}
			}
			add_deposit = d_tec_engineered_eco_ring_1
		}
		10 = {	# Energy
			modifier = {
				factor = 100
				OR = {
					has_generator_designation = yes
					has_rural_designation = yes
				}
			}
			add_deposit = d_tec_preserved_eco_ring_2
		}
		10 = {
			modifier = {
				factor = 100
				OR = {
					has_trade_designation = yes
					has_fortress_designation = yes
				}
			}
			add_deposit = d_tec_engineered_eco_ring_3
		}
	}
}

tec_terraformer_deposit_effect = {
	if = {
		limit = {
			owner = {
				tec_is_terraformer_keeper_empire = yes
			}
		}
		while = {
			count = $count$
			tec_terraformer_keeper_$type$_deposit_effect = yes
		}
	}
	if = {
		limit = {
			owner = {
				tec_is_terraformer_environmentalist_empire = yes
			}
		}
		while = {
			count = $count$
			tec_terraformer_environmentalist_$type$_deposit_effect = yes
		}
	}
	if = {
		limit = {
			owner = {
				tec_is_terraformer_engineer_empire = yes
			}
		}
		while = {
			count = $count$
			tec_terraformer_engineers_$type$_deposit_effect = yes
		}
	}
	if = {
		limit = {
			owner = {
				tec_is_terraformer_preserver_empire = yes
			}
		}
		while = {
			count = $count$
			tec_terraformer_preserver_$type$_deposit_effect = yes
		}
	}
}

tec_add_engineered_weather = {
	if = {
		limit = {
			NOT = {
				has_modifier = pm_tec_engineered_weather
			}
		}
		add_modifier = {
			modifier = pm_tec_engineered_weather
			days = -1
		}
	}
}

tec_add_engineered_habitat = {
	if = {
		limit = {
			NOT = {
				has_modifier = pm_tec_engineered_habitat
			}
		}
		add_modifier = {
			modifier = pm_tec_engineered_habitat
			days = -1
		}
	}
}

tec_faction_terraform_effect = {
	change_variable = {
		which = tec_terraformed_worlds
		value = 1
	}
}

# Galactic Paragons

tec_country_get_robot_species = {
	optimize_memory
	if = {	# get true if exists
		# If the empire has robotic species, adapts the aiauth to it
		limit = {
			OR = {
				any_galaxy_species = {
					OR = {
						has_species_flag = mechanical_species@prev
					}
				}
			}
		}
		random_galaxy_species = {
			limit = {
				has_species_flag = mechanical_species@prev
			}
			save_event_target_as = tec_robot_search_species
		}
	}
	else_if = {	# Get fake then
		limit = {
			OR = {
				any_galaxy_species = {
					OR = {
						has_species_flag = mechanical_species_fake_@prev
					}

				}
			}
		}
		random_galaxy_species = {
			limit = {
				has_species_flag = mechanical_species_fake_@prev
			}
			save_event_target_as = tec_robot_search_species
		}
	}
	else = {
		# Creates a fake robot species
		# Later when the robot tech is researched the leader change species
		tec_create_fake_robot_species = yes
		last_created_species = {
			save_event_target_as = tec_robot_search_species
		}
	}
}

tec_country_aiauth_prepare_ai_species = {
	optimize_memory
	if = {
		limit = {
			NOT = { exists = event_target:tec_ai_species }
		}

		if = {
			limit = {
				is_individual_machine = yes
			}
			owner_main_species = {
				save_event_target_as = tec_ai_species
			}
		}
		else = {
			tec_country_get_robot_species = yes
			event_target:tec_robot_search_species = {
				save_event_target_as = tec_ai_species
			}
		}
	}
}

tec_country_create_aiauth_ruler = {
	inline_script = {
		script = tec_type_hint
		[[class] leader_class = $class$ ]
		[[ethic] ethic = $ethic$ ]
	}

	set_country_flag = tec_force_councilor_traits
	tec_country_aiauth_prepare_ai_species = yes
	create_leader = {
		class = $class|official$
		species = event_target:tec_ai_species
		name = tec_aiauth_ruler
		skill = 1
		gender = indeterminable
		event_leader = yes
		skip_background_generation = yes
		can_manually_change_location = no
		can_assign_to_council = yes
		hide_leader = no
		immortal = yes
		custom_description = councilor_tec_aiauth_ruler_desc
		randomize_traits = yes
		background_ethic = $ethic|ethic_gestalt_consciousness$
		effect = {
			save_event_target_as = tec_aiauth_ruler
		}
	}
	event_target:tec_aiauth_ruler = {
		set_leader_flag = tec_no_species_traits
		add_trait_no_notify = leader_trait_tec_aiauth_ruler
		tec_leader_add_councilor_trait = yes
		set_owner = prev
		tec_leader_handle_starting_modifiers = {
			from = prev
		}
		set_leader_flag = leader_death_events_blocked
		set_leader_flag = tec_avoid_portait_change
		set_leader_flag = tec_aiauth_ruler_@prev
	}
	assign_leader = event_target:tec_aiauth_ruler
	remove_country_flag = tec_force_councilor_traits
}

tec_country_create_aiauth_ruler_replace = {
	inline_script = {
		script = tec_type_hint
		leader_scope = $ruler$
	}

	set_country_flag = tec_force_councilor_traits
	set_country_flag = tec_no_starting_traits_modification
	set_country_flag = tec_no_starting_skill_modification
	tec_country_aiauth_prepare_ai_species = yes
	$ruler$ = {
		save_event_target_as = tec_replaced_ruler
	}
	clone_leader = {
		target = event_target:tec_replaced_ruler
		species = event_target:tec_ai_species
		gender = indeterminable
		event_leader = yes
		skip_background_generation = yes
		can_manually_change_location = no
		can_assign_to_council = yes
		hide_leader = no
		immortal = yes
		custom_description = councilor_tec_aiauth_ruler_desc
		randomize_traits = no
	}
	last_created_leader = {
		save_event_target_as = tec_aiauth_ruler
		set_leader_flag = tec_no_species_traits
		change_background_job = none
		copy_flags_and_variables_from = event_target:tec_replaced_ruler
		change_leader_portrait = event_target:tec_ai_species
		set_name = event_target:tec_replaced_ruler
		add_trait_no_notify = leader_trait_tec_aiauth_ruler
		tec_leader_add_councilor_trait = yes
		set_owner = prev
		set_leader_flag = tec_force_starting_actions
		tec_leader_handle_starting_modifiers = {
			from = prev
		}
		remove_leader_flag = tec_force_starting_actions
		set_leader_flag = leader_death_events_blocked
		set_leader_flag = tec_avoid_portait_change
		set_leader_flag = tec_aiauth_ruler_@prev
	}
	assign_leader = event_target:tec_aiauth_ruler

	remove_country_flag = tec_force_councilor_traits
	remove_country_flag = tec_no_starting_traits_modification
	remove_country_flag = tec_no_starting_skill_modification

	event_target:tec_replaced_ruler = {
		exile_leader_as = destitute_ruler_ai_auth
	}
}

tec_country_refragment_aiauth_ruler = {
	inline_script = {
		script = tec_type_hint
		[[ethic] ethic = $ethic$ ]
	}

	inline_script = {
		script = iterators/tec_iterate_leader_class
		code = "
			if = {
				limit = {
					has_country_flag = tec_fragmenting_\$leader_class\$
				}
				tec_country_create_aiauth_ruler = {
					class = \$leader_class\$
					ethic = \$ethic\$
				}
			}
		"
		ethic = $ethic|ethic_gestalt_consciousness$
	}

	event_target:tec_aiauth_ruler = {
		if = {
			limit = {
				exists = event_target:tec_aiauth_pre_refragment
			}
			set_name = event_target:tec_aiauth_pre_refragment
			change_leader_portrait = event_target:tec_aiauth_pre_refragment
		}
		while = {
			count = prev.tec_aiauth_ruler_level
			add_skill_without_trait_selection = 1
		}
	}
}

tec_country_create_aiauth_councilor = {
	inline_script = {
		script = tec_type_hint
		localisation = $name$
		localisation = $desc$
		leader_class = $class$
		[[council_pos] councilor = $council_pos$ ]
		[[ethic] ethic = $ethic$ ]
	}
	set_country_flag = tec_force_councilor_traits
	tec_country_aiauth_prepare_ai_species = yes
	create_leader = {
		class = $class$
		species = event_target:tec_ai_species
		name = $name$
		skill = 1
		gender = indeterminable
		event_leader = yes
		background_planet = home_planet
		can_manually_change_location = no
		can_assign_to_council = yes
		hide_leader = no
		immortal = yes
		custom_description = $desc$
		randomize_traits = yes
		background_ethic = $ethic|ethic_gestalt_consciousness$
		effect = {
			set_leader_flag = tec_no_species_traits
			save_event_target_as = tec_aiauth_councilor
			log = "Teeeeest"
			if = {	# Avoids sudden synth trait to appear
				limit = {
					has_trait = leader_trait_synthetic
				}
				remove_trait = leader_trait_synthetic
			}
		}
	}
	last_created_leader = {
		save_event_target_as = tec_aiauth_councilor
		set_owner = prev
		add_trait_no_notify = leader_trait_tec_aiauth_node
		tec_leader_add_councilor_trait = yes
		[[council_pos]
			set_council_position = $council_pos$
		]
		tec_leader_handle_starting_modifiers = {
			from = prev
		}
		tec_leader_set_aiauth_node_portait_effect = yes
		set_leader_flag = leader_death_events_blocked
		set_leader_flag = tec_avoid_portait_change
		tec_leader_add_starting_skill = yes
	}
	[[!ethic]
		if = {	# Removes gestalt ethic
			limit = {
				event_target:tec_aiauth_councilor = {
					has_ethic = ethic_gestalt_consciousness
				}
			}
			# this = country
			# event_target:tec_aiauth_councilor = node
			tec_country_aiauth_councilor_assign_ethic = {
				target_scope = "event_target:tec_aiauth_councilor"
			}
		}
	]
	remove_country_flag = tec_force_councilor_traits
}

tec_country_aiauth_councilor_assign_ethic = {
	inline_script = {
		script = tec_type_hint
		leader_scope = $target_scope$
	}
	random_owned_pop = {
		limit = {
			# Happiness = ethic
			pop_has_happiness = yes
			NOR = {
				has_trait = trait_zombie
				has_trait = trait_nerve_stapled
				has_trait = trait_presapient_proles
				has_trait = trait_syncretic_proles
			}
			# Lets avoid repetitive things
			NOT = {
				has_pop_flag = tec_temp_pop_aiauth
			}
		}
		save_event_target_as = tec_temp_pop
	}
	event_target:tec_temp_pop = {
		# Lets avoid repetitive things
		set_timed_pop_flag = {
			flag = tec_temp_pop_aiauth
			days = 1
		}
		switch = {
			trigger = has_ethic
			# Vanilla
			inline_script = {
				script = iterators/tec_iterate_ethic_regular
				code = "
					ethic_\$ethic\$ = {
						\$target_scope\$ = {
							change_background_ethic = ethic_\$ethic\$
						}
					}
				"
				target_scope = $target_scope$
			}
		}
	}
}


tec_country_cleanup_aiauth_fragment_class_flags = {
	inline_script = {
		script = iterators/tec_iterate_leader_class
		code = "
			remove_country_flag = tec_fragmenting_\$leader_class\$
		"
	}
}

tec_country_refragment_aiauth_councilor = {
	inline_script = {
		script = tec_type_hint
		[[ethic] ethic = $ethic$ ]
	}
	inline_script = {
		script = iterators/tec_iterate_leader_class
		code = "
			if = {
				limit = {
					has_country_flag = tec_fragmenting_\$leader_class\$
				}
				tec_country_create_aiauth_councilor = {
					class = \$leader_class\$
					name = councilor_tec_aiauth_fragment_\$leader_class\$
					desc = councilor_tec_aiauth_fragment_\$leader_class\$_desc
					ethic = \$ethic\$
				}
			}
		"
		ethic = $ethic|ethic_gestalt_consciousness$
	}
}

tec_country_aiauth_set_fragmenting_class_flag = {
	inline_script = {
		script = tec_type_hint
		leader_scope = $leader$
	}

	$leader$ = {
		switch = {
			trigger = leader_class
			inline_script = {
				script = iterators/tec_iterate_leader_class
				code = "
					\$leader_class\$ = {
						prev = { set_country_flag = tec_fragmenting_\$leader_class\$ }
					}
				"
			}
		}
	}

}

tec_country_create_aiauth_planetary_governing_node = {
	optimize_memory
	inline_script = {
		script = tec_type_hint
		[[ethic] ethic = $ethic$ ]
	}

	set_country_flag = tec_force_normal_traits
	tec_country_aiauth_prepare_ai_species = yes

	inline_script = {
		script = iterators/tec_iterate_leader_class
		code = "
			if = {
				limit = {
					has_country_flag = tec_fragmenting_\$leader_class\$
				}
				create_leader = {
					class = \$leader_class\$
					species = event_target:tec_ai_species
					name = tec_aiauth_planetary_governing_node
					skill = 1
					gender = indeterminable
					event_leader = yes
					skip_background_generation = yes
					can_manually_change_location = no
					hide_leader = no
					immortal = yes
					can_assign_to_council = no
					background_planet = event_target:tec_aiauth_planetary_governing_node_planet
					custom_description = tec_aiauth_planetary_governing_node_desc
					randomize_traits = yes
					background_ethic = \$ethic\$
					effect = {
						if = {	# Avoids sudden synth trait to appear
							limit = {
								has_trait = leader_trait_synthetic
							}
							remove_trait = leader_trait_synthetic
						}
						set_leader_flag = tec_no_species_traits
						save_event_target_as = tec_aiauth_planetary_governing_node
					}
				}
			}
		"
		ethic = $ethic|ethic_gestalt_consciousness$
	}

	last_created_leader = {
		save_event_target_as = tec_aiauth_planetary_governing_node
		set_leader_flag = tec_no_species_traits
		add_trait_no_notify = leader_trait_tec_aiauth_planetary_governing_node
		set_owner = prev
		tec_leader_add_governor_trait = yes

		tec_leader_handle_starting_modifiers = {
			from = prev
		}
		tec_leader_add_starting_skill = yes
		set_name = {
			key = "tec_aiauth_planetary_governing_node"
			variable_string = "[tec_aiauth_planetary_governing_node_planet.GetName]"
		}
		tec_leader_set_aiauth_node_portait_effect = yes
		set_leader_flag = tec_avoid_portait_change
		set_leader_flag = leader_death_events_blocked
	}
	remove_country_flag = tec_force_normal_traits
}

tec_country_refragment_aiauth_node = {
	inline_script = {
		script = tec_type_hint
		scripted_effect = $fragment_effect$
		leader_scope = $leader$
	}
	$leader$ = {
		save_event_target_as = tec_aiauth_pre_refragment
		switch = {
			trigger = has_ethic
			inline_script = {
				script = iterators/tec_iterate_ethic_regular
				code = "
					ethic_\$ethic\$ = {
						prev = {
							\$fragment_effect\$ = {
								ethic = ethic_\$ethic\$
							}
						}
					}
				"
				fragment_effect = $fragment_effect$
			}
		}
	}
}

tec_country_fragment_aiauth_node_cost = {
	add_resource = {
		unity = -1
		mult = value:tec_aiauth_fragment_cost
	}
}


tec_country_defaulted_aiauth_ai_power_situation_tooltip = {
	tooltip = {
		owner = { tec_country_defaulted_aiauth_ai_power_effect = yes }
	}
	custom_tooltip = tec_deficit_situation_extra_ai_power_defaulted_tooltip
}

tec_country_defaulted_aiauth_ai_power_effect = {
	add_modifier = {
		modifier = pm_tec_country_ai_power_defaulted
		years = 10
	}
	hidden_effect = {
		if = {
			limit = { is_ai = yes }
			log = "AI [This.GetName] defaulted as a result of [Root.GetName] in [GetYear]"
		}
		else = {
			log = "Player [This.GetName] defaulted as a result of [Root.GetName] in [GetYear]"
		}
		every_owned_leader = {
			limit = {
				tec_is_aiauth_node = yes
				is_ruler = no
			}
			kill_leader = { show_notification = no }
		}
	}
	custom_tooltip = tec_end_ai_power_deficit_effect_tooltip
}


tec_planet_force_update_desgnation = {
	set_planet_flag = tec_force_designation_refresh
	set_colony_type = col_tec_force
	remove_planet_flag = tec_force_designation_refresh

}

tec_planet_psionically_ascend_pops_effect = {
	create_variable_if_not_exists = {
		VARIABLE = tec_psionic_planet_ascended_pops
		VALUE_IF_CREATED = 0
	}
	while = {
		count = value:tec_psionic_planet_ascension_pop_ascend
		remove_planet_flag = tec_psionic_planet_ascension_found_pop

		# Xenos
		if = {
			limit = {
				not = { has_planet_flag = tec_psionic_planet_ascension_found_pop }
				has_planet_flag = tec_psionic_planet_ascension_xenos
			}
			random_owned_pop = {
				limit = {
					species = {
						tec_is_any_psionic_species = yes
						NOT = { is_same_species = prev.owner.owner_main_species }
					}
					is_sapient = yes
				}

				kill_pop = yes
				prev = {
					set_planet_flag = tec_psionic_planet_ascension_found_pop
					change_variable = {
						which = tec_psionic_planet_ascended_pops
						value = 1
					}
				}
			}
		}

		# Slaves
		if = {
			limit = {
				not = { has_planet_flag = tec_psionic_planet_ascension_found_pop }
				has_planet_flag = tec_psionic_planet_ascension_slaves
			}
			random_owned_pop = {
				limit = {
					species = {
						tec_is_any_psionic_species = yes
					}
					is_enslaved = yes
					is_sapient = yes
				}

				kill_pop = yes
				prev = {
					set_planet_flag = tec_psionic_planet_ascension_found_pop
					change_variable = {
						which = tec_psionic_planet_ascended_pops
						value = 1
					}
				}
			}
		}

		# Non necrophage/elder
		if = {
			limit = {
				not = { has_planet_flag = tec_psionic_planet_ascension_found_pop }
				exists = owner
				owner = {
					OR = {
						has_origin = origin_necrophage
						has_civic = civic_tec_origin_elders
					}
				}
				count_owned_pop = {
					limit = {
						species = {
							tec_is_any_psionic_species = yes
							NOT = { has_trait = trait_necrophage }
							NOT = { has_trait = trait_tec_se_elder }
						}
						is_sapient = yes
					}
					count > 1
				}
			}
			random_owned_pop = {
				limit = {
					species = {
						tec_is_any_psionic_species = yes
						NOT = { has_trait = trait_necrophage }
						NOT = { has_trait = trait_tec_se_elder }
					}
					is_sapient = yes
				}

				kill_pop = yes
				prev = {
					set_planet_flag = tec_psionic_planet_ascension_found_pop
					change_variable = {
						which = tec_psionic_planet_ascended_pops
						value = 1
					}
				}
			}
		}

		# Rest
		if = {
			limit = {
				not = { has_planet_flag = tec_psionic_planet_ascension_found_pop }
			}
			random_owned_pop = {
				limit = {
					species = {
						tec_is_any_psionic_species = yes
					}
					is_sapient = yes
				}

				kill_pop = yes
				prev = {
					set_planet_flag = tec_psionic_planet_ascension_found_pop
					change_variable = {
						which = tec_psionic_planet_ascended_pops
						value = 1
					}
				}
			}
		}
	}
}

tec_set_bioservant_portrait_effect = {
	if = {
		limit = {
			prev = { use_bioservant_portrait_sd_hum_bioservant = yes }
		}
		change_species_characteristics = { portrait = "pre_mam13" }
	}
	else_if = {
		limit = {
			prev = { use_bioservant_portrait_sd_mam_bioservant = yes }
		}
		change_species_characteristics = { portrait = "pre_mam6" }
	}
	else_if = {
		limit = {
			prev = { use_bioservant_portrait_sd_rep_bioservant = yes }
		}
		change_species_characteristics = { portrait = "pre_rep12" }
	}
	else_if = {
		limit = {
			prev = { use_bioservant_portrait_sd_avi_bioservant = yes }
		}
		change_species_characteristics = { portrait = "pre_avi12" }
	}
	else_if = {
		limit = {
			prev = { use_bioservant_portrait_sd_art_bioservant = yes }
		}
		change_species_characteristics = { portrait = "pre_art11" }
	}
	else_if = {
		limit = {
			prev = { use_bioservant_portrait_sd_mol_bioservant = yes }
		}
		change_species_characteristics = { portrait = "pre_mol3" }
	}
	else_if = {
		limit = {
			prev = { use_bioservant_portrait_sd_fun_bioservant = yes }
		}
		change_species_characteristics = { portrait = "pre_fun9" }
	}
	else_if = {
		limit = {
			prev = { use_bioservant_portrait_sd_pla_bioservant = yes }
		}
		change_species_characteristics = { portrait = "pre_fun13" }
	}
	else = {
		change_species_characteristics = { portrait = "pre_mam13" }
	}
}

tec_country_remove_gestalt_ethics = {
	country_remove_ethic = ethic_gestalt_consciousness
	inline_script = {
		script = iterators/tec_iterate_ethic_gestalt
		code = "
			country_remove_ethic = ethic_\$ethic\$
		"
	}
}

tec_country_convert_to_gestalt = {
	clear_ethos = yes
	shift_ethic = ethic_gestalt_consciousness

	while = {
		count = 2
		random_list = {
			inline_script = {
				script = iterators/tec_iterate_ethic_gestalt
				code = "
					1 = {
						modifier = {
							has_ethic = ethic_\$ethic\$
							mult = 0
						}
						shift_ethic = ethic_\$ethic\$
					}
				"
			}
		}
	}
}

# Traits
# ------------------------------------------------------------
	tec_generate_celestial_panspermia_blocker = {
		event_target:tec_celestial_owner = {
			if = {
				limit = {
					is_variable_set = tec_celestial_blockers_spawned
				}
				change_variable = {
					which = tec_celestial_blockers_spawned
					value = 1
				}
			}
			else = {
				set_variable = {
					which = tec_celestial_blockers_spawned
					value = 1
				}
			}
		}
		if = {	# Replicant
			limit = {
				event_target:tec_pop_to_clone = {
					tec_is_replicant = yes
					is_lithoid = no
				}
			}
			add_deposit = d_tec_celestial_biomechanical
		}
		else_if = {	# Lithoid
			limit = {
				event_target:tec_pop_to_clone = {
					is_lithoid = yes
				}
			}
			add_deposit = d_tec_celestial_lithoid
		}
		else = { # Normal
			add_deposit = d_tec_celestial_organic
		}
		if = {
			limit = {
				is_variable_set = tec_celestial_blockers_received
			}
			change_variable = {
				which = tec_celestial_blockers_received
				value = 1
			}
		}
		else = {
			set_variable = {
				which = tec_celestial_blockers_received
				value = 1
			}
		}
	}
	tec_generate_celestial_pop_from_blocker = {
		# TODO TRAIT move from the blockers
	}
# /

tec_species_swap_trait_if_exists = {
	inline_script = {
		script = tec_type_hint
		species_trait = $TRAIT$
		species_trait = $WITH$
	}
	if = {
		limit = {
			has_trait = $TRAIT$
		}
		change_species_characteristics = {
			remove_trait = $TRAIT$
			add_trait = $WITH$
		}
	}
}

tec_country_identity_trait_flag = {
	inline_script = {
		script = tec_type_hint
		species_trait = $trait$
	}
	if = {	# trait_tec_cryptobiotic
		limit = {
			any_owned_species = {
				has_trait = $trait$
			}
		}
		set_country_flag = tec_identity_$trait$
	}
}

tec_country_debug_set_indentity_trait_flags = {
	country_event = {
		id = tec_trait.5
	}
}