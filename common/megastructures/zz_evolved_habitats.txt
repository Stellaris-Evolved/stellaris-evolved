# common\megastructures\zz_evolved_habitats.txt

# Note:
# Dyson = 55k alloys for 4k energy (13.75 a per energy)
# Matter decompressor = 55k alloys for 2k minerals (27.5 a per mineral)
# Science nexus = 50k alloys for 300 research 10% re speed (55 a per sci)
# Mega art = 50k alloys for 300 unity 15% amenities (166 a per sci)

# If the cost of the subhab is 500 alloys, then production should be:
# - 20 energy for less less ratio as dyson (equ 4 jobs 5e)
# - 16 minerals for less ratio than matter (equ 4 jobs 4m)
# - 24 food for less ratio than matter (equ 4 jobs 6f)
# /


# Subhabitats
tec_subhabitat_standard = {
	entity = "habitat_phase_03_entity"
	construction_entity = "habitat_phase_03_entity"
	portrait = "GFX_megastructure_habitat_background"
	place_entity_on_planet_plane = no
	show_galactic_map_icon = no
	hide_name = yes
	show_in_outliner = no
	entity_offset = { x = -7 y = -7 }
	build_time = @tec_subhabitat_build_time

	resources = {
		category = megastructures_habitat
		cost = {
			alloys = @tec_subhabitat_alloy_cost
			unity = @tec_subhabitat_unity_cost
		}
	}

	construction_blocks_and_blocked_by = none

	potential = {
		# GIGAS COMP
		if = {
			limit = {
				has_global_flag = giga_game_started
			}
			 giga_are_habitats_available = yes
		}
		# /
		else = {
			OR = {
				has_technology = tech_habitat_1
				has_civic = civic_diadochi
				has_civic = civic_great_khans_legacy
				has_country_flag = democratic_khanate_flag
			}
		}
	}

	possible = {
		hidden_trigger = {
			exists = starbase
		}
		custom_tooltip = {
			fail_text = "requires_inside_border"
			is_inside_border = from
		}
		custom_tooltip = {
			fail_text = "tec_requires_habitat_central_complex_colonized"
			any_system_planet = {
				has_planet_flag = habitat
				is_colony = yes
			}
		}
	}

	placement_rules = {
		planet_possible = {
			custom_tooltip = {
				fail_text = "tec_requires_subhabitat_free_limit"
				solar_system = {
					check_variable = {
						which = tec_subhabitats_built
						value <= 3
					}
				}
			}
			custom_tooltip = {
				fail_text = "requires_surveyed_planet"
				is_surveyed = {			# prevent leaking habitability information
					who = prev.from
					status = yes
				}
			}
			custom_tooltip = {
				fail_text = "requires_no_anomaly"
				NOT = { has_anomaly = yes }
			}
			custom_tooltip = {
				fail_text = "requires_no_existing_megastructure"
				#can_build_megastructure_on_planet = yes
				NOR = {
					has_planet_flag = megastructure
					# EVOLVED
					has_planet_flag = has_megastructure
					#has_planet_flag = tec_has_orbital
					# /
					# /
					solar_system = {
						OR = {
							has_star_flag = ring_world_built
							has_star_flag = ithomes_gate
						}
					}
					is_planet_class = pc_ringworld_habitable
					is_planet_class = pc_ringworld_habitable_damaged
					is_planet_class = pc_ringworld_tech
					is_planet_class = pc_ringworld_tech_damaged
					is_planet_class = pc_ringworld_seam
					is_planet_class = pc_ringworld_seam_damaged
					is_planet_class = pc_habitat
				}
			}
			custom_tooltip = {
				fail_text = "requires_no_orbital_debris"
				NOR = {
					has_planet_flag = has_orbital_debris
				}
			}
			custom_tooltip = {
				fail_text = "tec_requires_deposits_or_food"
				OR = {
					has_deposit_for = shipclass_research_station
					has_deposit_for = shipclass_mining_station
					# Food ones
					is_planet_class = pc_gas_giant
					is_planet_class = pc_frozen
					is_planet_class = pc_ice_asteroid
				}
			}
			custom_tooltip = {
				fail_text = "requires_not_astral_scar"
				is_astral_scar = no
			}
			custom_tooltip = {
				fail_text = "requires_not_solarpunk"
				NOT = {
					solar_system = {
						has_star_flag = solarpunk_system_02
					}
				}
			}
		} # use these for all non-star megastructures
	}

	# root = system
	# from = country
	ai_weight = {
		factor = 2

		# AI Void Dwellers shouldn't build orbitals until it has a few habitats
		modifier = {
			factor = 0.5
			from = {
				has_void_dweller_origin = yes
				count_owned_planet = {
					count < 3
					limit = {
						has_planet_flag = habitat
					}
				}
			}
		}

		modifier = {
			factor = 2
			any_system_planet = {
				has_planet_flag = habitat
				free_district_slots < 2
			}
		}

		modifier = {
			factor = 2
			any_system_planet = {
				has_planet_flag = habitat
				free_building_slots < 1
			}
		}

		modifier = {	# Food ai guideline
			factor = 5
			from = {
				country_uses_food = yes
				resource_income_compare = {
					resource = food
					value < 20
				}
			}
			any_system_planet = {
				OR = {
					is_planet_class = pc_gas_giant
					is_planet_class = pc_frozen
					is_planet_class = pc_ice_asteroid
				}
			}
		}
	}

	# Anticheese
	on_build_queued = {
		solar_system = {
			change_variable = {
				which = tec_subhabitats_built
				value = 1
			}
		}
	}

	on_build_unqueued = {
		solar_system = {
			change_variable = {
				which = tec_subhabitats_built
				value = -1
			}
		}
	}

	on_build_complete = {
		fromfrom.planet = {
			save_event_target_as = target_planet
			set_planet_flag = has_megastructure
		}
		tec_on_subhabitat_complete_effect = yes

		event_target:target_habitat = {
			add_deposit_if_missing = {
				DEPOSIT = d_system_resources
			}
			add_deposit_if_missing = {
				DEPOSIT = d_orbital_research
			}
			add_deposit_if_missing = {
				DEPOSIT = d_orbital_energy
			}
			add_deposit_if_missing = {
				DEPOSIT = d_orbital_mining
			}
		}
		from = {
			country_event = {
				id = tec_habitats.25
			}
		}
		remove_megastructure = fromfrom
	}
}

tec_subhabitat_extraction = {
	entity = "habitat_phase_03_entity"
	construction_entity = "habitat_phase_03_entity"
	portrait = "GFX_megastructure_habitat_background"
	place_entity_on_planet_plane = no
	show_galactic_map_icon = no
	hide_name = yes
	show_in_outliner = no
	entity_offset = { x = -7 y = -7 }
	build_time = @tec_subhabitat_build_time

	resources = {
		category = megastructures_habitat
		cost = {
			alloys = @tec_subhabitat_alloy_cost
			unity = @tec_subhabitat_unity_cost
		}
		produces = {
			trigger = {
				NOT = {
					has_megastructure_flag = tec_subhabitat_extraction_low_production
				}
			}
			energy = 1
			multiplier = value:tec_subhabitat_scaling|BASE|@tec_subhabitat_base_energy|RESOURCE|energy|SCOPE|event_target:tec_habitat_of_@this.solar_system|
		}
		produces = {
			trigger = {
				NOT = {
					has_megastructure_flag = tec_subhabitat_extraction_low_production
				}
			}
			minerals = 1
			multiplier = value:tec_subhabitat_scaling|BASE|@tec_subhabitat_base_minerals|RESOURCE|minerals|SCOPE|event_target:tec_habitat_of_@this.solar_system|
		}
		produces = {
			trigger = {
				has_megastructure_flag = tec_subhabitat_extraction_low_production
			}
			energy = 0.5
			multiplier = value:tec_subhabitat_scaling|BASE|@tec_subhabitat_base_energy|RESOURCE|energy|SCOPE|event_target:tec_habitat_of_@this.solar_system|
		}
		produces = {
			trigger = {
				has_megastructure_flag = tec_subhabitat_extraction_low_production
			}
			minerals = 0.5
			multiplier = value:tec_subhabitat_scaling|BASE|@tec_subhabitat_base_minerals|RESOURCE|minerals|SCOPE|event_target:tec_habitat_of_@this.solar_system|
		}
	}

	construction_blocks_and_blocked_by = none

	potential = {
		always = no
	}

	possible = {
		always = no
	}

	placement_rules = {
		planet_possible = {
			always = no
		}
	}

	# Dismantle block
	dismantle_time = 120

	dismantle_cost = {
		category = megastructures_habitat
		cost = {
			energy = 100
		}
	}

	dismantle_potential = {
		always = yes
	}

	dismantle_possible = {
		can_dismantle_megastructure = {
			TECH = tech_habitat_1
		}
	}

	on_dismantle_start = {
		fromfrom.planet = {
			remove_planet_flag = has_megastructure
		}
	}
	on_dismantle_cancel = {
		fromfrom.planet = {
			set_planet_flag = has_megastructure
		}
	}
	on_dismantle_complete = {
		from = {
			add_resource = {
				alloys = @tec_subhabitat_alloy_cost
				mult = modifier:megastructure_dismantle_refund_mult
			}
		}
		solar_system = {
			change_variable = {
				which = tec_subhabitats_built
				value = -1
			}
			# Specific
			change_variable = {
				which = tec_subhabitats_extraction
				value = -1
			}
		}
	}
	# /

	# root = system
	# from = country
	ai_weight = {
		factor = 0
	}
}
tec_subhabitat_energy = {
	entity = "habitat_phase_03_entity"
	construction_entity = "habitat_phase_03_entity"
	portrait = "GFX_megastructure_habitat_background"
	place_entity_on_planet_plane = no
	show_galactic_map_icon = no
	hide_name = yes
	show_in_outliner = no
	entity_offset = { x = -7 y = -7 }
	build_time = @tec_subhabitat_build_time

	resources = {
		category = megastructures_habitat
		cost = {
			alloys = @tec_subhabitat_alloy_cost
			unity = @tec_subhabitat_unity_cost
		}
		produces = {
			energy = 1
			multiplier = value:tec_subhabitat_scaling|BASE|@tec_subhabitat_base_energy|RESOURCE|energy|SCOPE|event_target:tec_habitat_of_@this.solar_system|
		}
	}

	construction_blocks_and_blocked_by = none

	potential = {
		always = no
	}

	possible = {
		always = no
	}

	placement_rules = {
		planet_possible = {
			always = no
		}
	}

	# Dismantle block
	dismantle_time = 120

	dismantle_cost = {
		category = megastructures_habitat
		cost = {
			energy = 100
		}
	}

	dismantle_potential = {
		always = yes
	}

	dismantle_possible = {
		can_dismantle_megastructure = {
			TECH = tech_habitat_1
		}
	}

	on_dismantle_start = {
		fromfrom.planet = {
			remove_planet_flag = has_megastructure
		}
	}
	on_dismantle_cancel = {
		fromfrom.planet = {
			set_planet_flag = has_megastructure
		}
	}
	on_dismantle_complete = {
		from = {
			add_resource = {
				alloys = @tec_subhabitat_alloy_cost
				mult = modifier:megastructure_dismantle_refund_mult
			}
		}
		solar_system = {
			change_variable = {
				which = tec_subhabitats_built
				value = -1
			}
			# Specific
			change_variable = {
				which = tec_subhabitats_energy
				value = -1
			}
		}
	}
	# /

	# root = system
	# from = country
	ai_weight = {
		factor = 0
	}
}
tec_subhabitat_minerals = {
	entity = "habitat_phase_03_entity"
	construction_entity = "habitat_phase_03_entity"
	portrait = "GFX_megastructure_habitat_background"
	place_entity_on_planet_plane = no
	show_galactic_map_icon = no
	hide_name = yes
	show_in_outliner = no
	entity_offset = { x = -7 y = -7 }
	build_time = @tec_subhabitat_build_time

	resources = {
		category = megastructures_habitat
		cost = {
			alloys = @tec_subhabitat_alloy_cost
			unity = @tec_subhabitat_unity_cost
		}
		produces = {
			minerals = 1
			multiplier = value:tec_subhabitat_scaling|BASE|@tec_subhabitat_base_minerals|RESOURCE|minerals|SCOPE|event_target:tec_habitat_of_@this.solar_system|
		}
	}

	construction_blocks_and_blocked_by = none

	potential = {
		always = no
	}

	possible = {
		always = no
	}

	placement_rules = {
		planet_possible = {
			always = no
		}
	}

	# Dismantle block
	dismantle_time = 120

	dismantle_cost = {
		category = megastructures_habitat
		cost = {
			energy = 100
		}
	}

	dismantle_potential = {
		always = yes
	}

	dismantle_possible = {
		can_dismantle_megastructure = {
			TECH = tech_habitat_1
		}
	}

	on_dismantle_start = {
		fromfrom.planet = {
			remove_planet_flag = has_megastructure
		}
	}
	on_dismantle_cancel = {
		fromfrom.planet = {
			set_planet_flag = has_megastructure
		}
	}
	on_dismantle_complete = {
		from = {
			add_resource = {
				alloys = @tec_subhabitat_alloy_cost
				mult = modifier:megastructure_dismantle_refund_mult
			}
		}
		solar_system = {
			change_variable = {
				which = tec_subhabitats_built
				value = -1
			}
			# Specific
			change_variable = {
				which = tec_subhabitats_minerals
				value = -1
			}
		}
	}
	# /
	# root = system
	# from = country
	ai_weight = {
		factor = 0
	}
}
tec_subhabitat_food = {
	entity = "habitat_phase_03_entity"
	construction_entity = "habitat_phase_03_entity"
	portrait = "GFX_megastructure_habitat_background"
	place_entity_on_planet_plane = no
	show_galactic_map_icon = no
	hide_name = yes
	show_in_outliner = no
	entity_offset = { x = -7 y = -7 }
	build_time = @tec_subhabitat_build_time

	resources = {
		category = megastructures_habitat
		cost = {
			alloys = @tec_subhabitat_alloy_cost
			unity = @tec_subhabitat_unity_cost
		}
		produces = {
			food = 1
			multiplier = value:tec_subhabitat_scaling|BASE|@tec_subhabitat_base_food|RESOURCE|food|SCOPE|event_target:tec_habitat_of_@this.solar_system|
		}
	}

	construction_blocks_and_blocked_by = none

	potential = {
		always = no
	}

	possible = {
		always = no
	}

	placement_rules = {
		planet_possible = {
			always = no
		}
	}

	# Dismantle block
	dismantle_time = 120

	dismantle_cost = {
		category = megastructures_habitat
		cost = {
			energy = 100
		}
	}

	dismantle_potential = {
		always = yes
	}

	dismantle_possible = {
		can_dismantle_megastructure = {
			TECH = tech_habitat_1
		}
	}

	on_dismantle_start = {
		fromfrom.planet = {
			remove_planet_flag = has_megastructure
		}
	}
	on_dismantle_cancel = {
		fromfrom.planet = {
			set_planet_flag = has_megastructure
		}
	}
	on_dismantle_complete = {
		from = {
			add_resource = {
				alloys = @tec_subhabitat_alloy_cost
				mult = modifier:megastructure_dismantle_refund_mult
			}
		}
		solar_system = {
			change_variable = {
				which = tec_subhabitats_built
				value = -1
			}
			# Specific
			change_variable = {
				which = tec_subhabitats_food
				value = -1
			}
		}
	}
	# /

	# root = system
	# from = country
	ai_weight = {
		factor = 0
	}
}

tec_subhabitat_physics = {
	entity = "habitat_phase_03_entity"
	construction_entity = "habitat_phase_03_entity"
	portrait = "GFX_megastructure_habitat_background"
	place_entity_on_planet_plane = no
	show_galactic_map_icon = no
	hide_name = yes
	show_in_outliner = no
	entity_offset = { x = -7 y = -7 }
	build_time = @tec_subhabitat_build_time

	resources = {
		category = megastructures_habitat
		cost = {
			alloys = @tec_subhabitat_alloy_cost
			unity = @tec_subhabitat_unity_cost
		}
		produces = {
			physics_research = 1
			multiplier = value:tec_subhabitat_scaling|BASE|@tec_subhabitat_base_research|RESOURCE|research|SCOPE|event_target:tec_habitat_of_@this.solar_system|
		}
	}

	construction_blocks_and_blocked_by = none

	potential = {
		always = no
	}

	possible = {
		always = no
	}

	placement_rules = {
		planet_possible = {
			always = no
		}
	}

	# Dismantle block
	dismantle_time = 120

	dismantle_cost = {
		category = megastructures_habitat
		cost = {
			energy = 100
		}
	}

	dismantle_potential = {
		always = yes
	}

	dismantle_possible = {
		can_dismantle_megastructure = {
			TECH = tech_habitat_1
		}
	}

	on_dismantle_start = {
		fromfrom.planet = {
			remove_planet_flag = has_megastructure
		}
	}
	on_dismantle_cancel = {
		fromfrom.planet = {
			set_planet_flag = has_megastructure
		}
	}
	on_dismantle_complete = {
		from = {
			add_resource = {
				alloys = @tec_subhabitat_alloy_cost
				mult = modifier:megastructure_dismantle_refund_mult
			}
		}
		solar_system = {
			change_variable = {
				which = tec_subhabitats_built
				value = -1
			}
			# Specific
			change_variable = {
				which = tec_subhabitats_science
				value = -1
			}
		}
	}
	# /

	# root = system
	# from = country
	ai_weight = {
		factor = 0
	}
}
tec_subhabitat_society = {
	entity = "habitat_phase_03_entity"
	construction_entity = "habitat_phase_03_entity"
	portrait = "GFX_megastructure_habitat_background"
	place_entity_on_planet_plane = no
	show_galactic_map_icon = no
	hide_name = yes
	show_in_outliner = no
	entity_offset = { x = -7 y = -7 }
	build_time = @tec_subhabitat_build_time

	resources = {
		category = megastructures_habitat
		cost = {
			alloys = @tec_subhabitat_alloy_cost
			unity = @tec_subhabitat_unity_cost
		}
		produces = {
			society_research = 1
			multiplier = value:tec_subhabitat_scaling|BASE|@tec_subhabitat_base_research|RESOURCE|research|SCOPE|event_target:tec_habitat_of_@this.solar_system|
		}
	}

	construction_blocks_and_blocked_by = none

	potential = {
		always = no
	}

	possible = {
		always = no
	}

	placement_rules = {
		planet_possible = {
			always = no
		}
	}

	# Dismantle block
	dismantle_time = 120

	dismantle_cost = {
		category = megastructures_habitat
		cost = {
			energy = 100
		}
	}

	dismantle_potential = {
		always = yes
	}

	dismantle_possible = {
		can_dismantle_megastructure = {
			TECH = tech_habitat_1
		}
	}

	on_dismantle_start = {
		fromfrom.planet = {
			remove_planet_flag = has_megastructure
		}
	}
	on_dismantle_cancel = {
		fromfrom.planet = {
			set_planet_flag = has_megastructure
		}
	}
	on_dismantle_complete = {
		from = {
			add_resource = {
				alloys = @tec_subhabitat_alloy_cost
				mult = modifier:megastructure_dismantle_refund_mult
			}
		}
		solar_system = {
			change_variable = {
				which = tec_subhabitats_built
				value = -1
			}
			# Specific
			change_variable = {
				which = tec_subhabitats_science
				value = -1
			}
		}
	}
	# /

	# root = system
	# from = country
	ai_weight = {
		factor = 0
	}
}
tec_subhabitat_engineering = {
	entity = "habitat_phase_03_entity"
	construction_entity = "habitat_phase_03_entity"
	portrait = "GFX_megastructure_habitat_background"
	place_entity_on_planet_plane = no
	show_galactic_map_icon = no
	hide_name = yes
	show_in_outliner = no
	entity_offset = { x = -7 y = -7 }
	build_time = @tec_subhabitat_build_time

	resources = {
		category = megastructures_habitat
		cost = {
			alloys = @tec_subhabitat_alloy_cost
			unity = @tec_subhabitat_unity_cost
		}
		produces = {
			engineering_research = 1
			multiplier = value:tec_subhabitat_scaling|BASE|@tec_subhabitat_base_research|RESOURCE|research|SCOPE|event_target:tec_habitat_of_@this.solar_system|
		}
	}

	construction_blocks_and_blocked_by = none

	potential = {
		always = no
	}

	possible = {
		always = no
	}

	placement_rules = {
		planet_possible = {
			always = no
		}
	}

	# Dismantle block
	dismantle_time = 120

	dismantle_cost = {
		category = megastructures_habitat
		cost = {
			energy = 100
		}
	}

	dismantle_potential = {
		always = yes
	}

	dismantle_possible = {
		can_dismantle_megastructure = {
			TECH = tech_habitat_1
		}
	}

	on_dismantle_start = {
		fromfrom.planet = {
			remove_planet_flag = has_megastructure
		}
	}
	on_dismantle_cancel = {
		fromfrom.planet = {
			set_planet_flag = has_megastructure
		}
	}
	on_dismantle_complete = {
		from = {
			add_resource = {
				alloys = @tec_subhabitat_alloy_cost
				mult = modifier:megastructure_dismantle_refund_mult
			}
		}
		solar_system = {
			change_variable = {
				which = tec_subhabitats_built
				value = -1
			}
			# Specific
			change_variable = {
				which = tec_subhabitats_science
				value = -1
			}
		}
	}
	# /

	# root = system
	# from = country
	ai_weight = {
		factor = 0
	}
}
tec_subhabitat_science = {
	entity = "habitat_phase_03_entity"
	construction_entity = "habitat_phase_03_entity"
	portrait = "GFX_megastructure_habitat_background"
	place_entity_on_planet_plane = no
	show_galactic_map_icon = no
	hide_name = yes
	show_in_outliner = no
	entity_offset = { x = -7 y = -7 }
	build_time = @tec_subhabitat_build_time

	resources = {
		category = megastructures_habitat
		cost = {
			alloys = @tec_subhabitat_alloy_cost
			unity = @tec_subhabitat_unity_cost
		}
		produces = {
			physics_research = 0.75
			society_research = 0.75
			engineering_research = 0.75
			multiplier = value:tec_subhabitat_scaling|BASE|@tec_subhabitat_base_research|RESOURCE|research|SCOPE|event_target:tec_habitat_of_@this.solar_system|
		}
	}

	construction_blocks_and_blocked_by = none

	potential = {
		always = no
	}

	possible = {
		always = no
	}

	placement_rules = {
		planet_possible = {
			always = no
		}
	}

	# Dismantle block
	dismantle_time = 120

	dismantle_cost = {
		category = megastructures_habitat
		cost = {
			energy = 100
		}
	}

	dismantle_potential = {
		always = yes
	}

	dismantle_possible = {
		can_dismantle_megastructure = {
			TECH = tech_habitat_1
		}
	}

	on_dismantle_start = {
		fromfrom.planet = {
			remove_planet_flag = has_megastructure
		}
	}
	on_dismantle_cancel = {
		fromfrom.planet = {
			set_planet_flag = has_megastructure
		}
	}
	on_dismantle_complete = {
		from = {
			add_resource = {
				alloys = @tec_subhabitat_alloy_cost
				mult = modifier:megastructure_dismantle_refund_mult
			}
		}
		solar_system = {
			change_variable = {
				which = tec_subhabitats_built
				value = -1
			}
			# Specific
			change_variable = {
				which = tec_subhabitats_science
				value = -1
			}
		}
	}
	# /

	# root = system
	# from = country
	ai_weight = {
		factor = 0
	}
}

#tec_subhabitat_alloys
#tec_subhabitat_cgs
#tec_subhabitat_gases
#tec_subhabitat_crystals
#tec_subhabitat_motes

#tec_subhabitat_artifacts
#tec_subhabitat_astral

#tec_subhabitat_dark
#tec_subhabitat_crisis_logic

# Note: For modding, new subhabitats need to be added to:
# tec_num_subhabitats (zz_evolved_mechanic_script_values.txt)
# tec_on_subhabitat_complete_effect (zz_evolved_arcology_scripted_effects)
# tec_is_subhabitat_megastructure (zzz_evolved_galaxy_gen_scripted_triggers)
# new resources must be declared at zz_evolved_scripted_modifiers
# and loc, ofc, at zz_evolved_planet_modifiers_l_english

# The default use of the multiplier is this
# multiplier = value:tec_subhabitat_scaling|BASE|20|RESOURCE|energy|SCOPE|event_target:tec_habitat_of_@from.solar_system|
